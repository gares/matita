(**************************************************************************)
(*       ___                                                              *)
(*      ||M||                                                             *)
(*      ||A||       A project by Andrea Asperti                           *)
(*      ||T||                                                             *)
(*      ||I||       Developers:                                           *)
(*      ||T||         The HELM team.                                      *)
(*      ||A||         http://helm.cs.unibo.it                             *)
(*      \   /                                                             *)
(*       \ /        This file is distributed under the terms of the       *)
(*        v         GNU General Public License Version 2                  *)
(*                                                                        *)
(**************************************************************************)

include "basic_2/notation/relations/psubsteval_6.ma".
include "basic_2/relocation/cny.ma".
include "basic_2/substitution/cpys.ma".

(* EVALUATION FOR CONTEXT-SENSITIVE EXTENDED SUBSTITUTION ON TERMS **********)

definition cpye: ynat ‚Üí ynat ‚Üí relation4 genv lenv term term ‚âù
                 Œªd,e,G,L,T1,T2. ‚¶ÉG, L‚¶Ñ ‚ä¢ T1 ‚ñ∂*[d, e] T2 ‚àß ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ñ∂[d, e] ùêç‚¶ÉT2‚¶Ñ.

interpretation "evaluation for context-sensitive extended substitution (term)"
   'PSubstEval G L T1 T2 d e = (cpye d e G L T1 T2).

(* Basic_properties *********************************************************)

(* Note: this should go in subconversion *)
lemma leqy_cpye_trans: ‚àÄG,L2,T1,T2,d,e. ‚¶ÉG, L2‚¶Ñ ‚ä¢ T1 ‚ñ∂*[d, e] ùêç‚¶ÉT2‚¶Ñ ‚Üí
                       ‚àÄL1. L1 ‚äë√ó[d, e] L2 ‚Üí L2 ‚äë√ó[d, e] L1 ‚Üí ‚¶ÉG, L1‚¶Ñ ‚ä¢ T1 ‚ñ∂*[d, e] ùêç‚¶ÉT2‚¶Ñ.
#G #L2 #T1 #T2 #d #e *
/4 width=8 by lsuby_cpys_trans, lsuby_cny_conf, conj/
qed-.

lemma cpye_sort: ‚àÄG,L,d,e,k. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ãÜk ‚ñ∂*[d, e] ùêç‚¶É‚ãÜk‚¶Ñ.
/3 width=5 by cny_sort, conj/ qed.

lemma cpye_free: ‚àÄG,L,d,e,i. |L| ‚â§ i ‚Üí ‚¶ÉG, L‚¶Ñ ‚ä¢ #i ‚ñ∂*[d, e] ùêç‚¶É#i‚¶Ñ.
/3 width=6 by cny_lref_free, conj/ qed.

lemma cpye_top: ‚àÄG,L,d,e,i. d + e ‚â§ yinj i ‚Üí ‚¶ÉG, L‚¶Ñ ‚ä¢ #i ‚ñ∂*[d, e] ùêç‚¶É#i‚¶Ñ.
/3 width=6 by cny_lref_top, conj/ qed.

lemma cpye_skip: ‚àÄG,L,d,e,i. yinj i < d ‚Üí ‚¶ÉG, L‚¶Ñ ‚ä¢ #i ‚ñ∂*[d, e] ùêç‚¶É#i‚¶Ñ.
/3 width=6 by cny_lref_skip, conj/ qed.

lemma cpye_gref: ‚àÄG,L,d,e,p. ‚¶ÉG, L‚¶Ñ ‚ä¢ ¬ßp ‚ñ∂*[d, e] ùêç‚¶É¬ßp‚¶Ñ.
/3 width=5 by cny_gref, conj/ qed.

lemma cpye_bind: ‚àÄG,L,V1,V2,d,e. ‚¶ÉG, L‚¶Ñ ‚ä¢ V1 ‚ñ∂*[d, e] ùêç‚¶ÉV2‚¶Ñ ‚Üí
                 ‚àÄI,T1,T2. ‚¶ÉG, L.‚ìë{I}V1‚¶Ñ ‚ä¢ T1 ‚ñ∂*[‚´Ød, e] ùêç‚¶ÉT2‚¶Ñ ‚Üí
                 ‚àÄa. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ìë{a,I}V1.T1 ‚ñ∂*[d, e] ùêç‚¶É‚ìë{a,I}V2.T2‚¶Ñ.
#G #L #V1 #V2 #d #e * #HV12 #HV2 #I #T1 #T2 *
/5 width=8 by cpys_bind, cny_bind, lsuby_cny_conf, lsuby_succ, conj/
qed.

lemma cpye_flat: ‚àÄG,L,V1,V2,d,e. ‚¶ÉG, L‚¶Ñ ‚ä¢ V1 ‚ñ∂*[d, e] ùêç‚¶ÉV2‚¶Ñ ‚Üí
                 ‚àÄT1,T2. ‚¶ÉG, L‚¶Ñ ‚ä¢ T1 ‚ñ∂*[d, e] ùêç‚¶ÉT2‚¶Ñ ‚Üí
                 ‚àÄI. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ìï{I}V1.T1 ‚ñ∂*[d, e] ùêç‚¶É‚ìï{I}V2.T2‚¶Ñ.
#G #L #V1 #V2 #d #e * #HV12 #HV2 #T1 #T2 *
/3 width=7 by cpys_flat, cny_flat, conj/
qed.

(* Basic inversion lemmas ***************************************************)

lemma cpye_inv_sort1: ‚àÄG,L,X,d,e,k. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ãÜk ‚ñ∂*[d, e] ùêç‚¶ÉX‚¶Ñ ‚Üí X = ‚ãÜk.
#G #L #X #d #e #k * /2 width=5 by cpys_inv_sort1/
qed-.

lemma cpye_inv_gref1: ‚àÄG,L,X,d,e,p. ‚¶ÉG, L‚¶Ñ ‚ä¢ ¬ßp ‚ñ∂*[d, e] ùêç‚¶ÉX‚¶Ñ ‚Üí X = ¬ßp.
#G #L #X #d #e #p * /2 width=5 by cpys_inv_gref1/
qed-.

lemma cpye_inv_bind1: ‚àÄa,I,G,L,V1,T1,X,d,e. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ìë{a,I}V1.T1 ‚ñ∂*[d, e] ùêç‚¶ÉX‚¶Ñ ‚Üí
                      ‚àÉ‚àÉV2,T2. ‚¶ÉG, L‚¶Ñ ‚ä¢ V1 ‚ñ∂*[d, e] ùêç‚¶ÉV2‚¶Ñ & ‚¶ÉG, L.‚ìë{I}V1‚¶Ñ ‚ä¢ T1 ‚ñ∂*[‚´Ød, e] ùêç‚¶ÉT2‚¶Ñ &
                               X = ‚ìë{a,I}V2.T2.
#a #I #G #L #V1 #T1 #X #d #e * #H1 #H2 elim (cpys_inv_bind1 ‚Ä¶ H1) -H1
#V2 #T2 #HV12 #HT12 #H destruct elim (cny_inv_bind ‚Ä¶ H2) -H2
/5 width=8 by lsuby_cny_conf, lsuby_succ, ex3_2_intro, conj/
qed-.

lemma cpye_inv_flat1: ‚àÄI,G,L,V1,T1,X,d,e. ‚¶ÉG, L‚¶Ñ ‚ä¢ ‚ìï{I}V1.T1 ‚ñ∂*[d, e] ùêç‚¶ÉX‚¶Ñ ‚Üí
                      ‚àÉ‚àÉV2,T2. ‚¶ÉG, L‚¶Ñ ‚ä¢ V1 ‚ñ∂*[d, e] ùêç‚¶ÉV2‚¶Ñ & ‚¶ÉG, L‚¶Ñ ‚ä¢ T1 ‚ñ∂*[d, e] ùêç‚¶ÉT2‚¶Ñ &
                               X = ‚ìï{I}V2.T2.
#I #G #L #V1 #T1 #X #d #e * #H1 #H2 elim (cpys_inv_flat1 ‚Ä¶ H1) -H1
#V2 #T2 #HV12 #HT12 #H destruct elim (cny_inv_flat ‚Ä¶ H2) -H2
/3 width=5 by ex3_2_intro, conj/
qed-.
